<div style="float: left; width: 64%; padding: 1%;">

好的，同学们，我们进入第四章《网络层》的学习。这一章是计算机网络的**核心枢纽**，上承传输层，下启数据链路层，是考研**绝对的命题重点**，尤其是**IPv4地址规划**和**路由协议**的计算与分析，每年必考，分值极高。

本章内容多、协议多、计算多，但掌握了方法就是“纸老虎”。跟紧我的节奏，我们把网络层这块“硬骨头”嚼碎了、吃透了！

---

### **第4章 网络层**

**本章定位**：如果说数据链路层是“同城快递”，负责相邻站点间的交付，那网络层就是**“跨省/跨国物流系统”**，它的核心任务是规划出一条**全局路径**，把数据包（分组）从**源主机**送到遥远的**目的主机**。

### **4.1 网络层的功能**

* **核心考点**:
    * 两大核心功能：`路由选择` 与 `分组转发`。
    * 两种服务模型：`虚电路` 与 `数据报` 的对比。
    * 拥塞控制与流量控制的区别。
* **形象记忆**:
    * **路由选择 (查地图)**: 像高德地图规划路线。路由器根据路由算法，计算并生成一张“地图”（**路由表**），找出到目的地的最佳路径。这是一个**慢过程**，是**控制层面**的事。
    * **分组转发 (按路牌走)**: 像十字路口的交警。看到一个数据包（车），迅速查看它的目的地，根据“路牌”（**转发表**）指示它从哪个路口（端口）出去。这是一个**快动作**，是**数据层面**的事。
    * **虚电路 vs 数据报**:
        * **虚电路 (坐火车)**: 通信前先铺好一条“虚拟”轨道（建立连接）。所有数据包都沿着这条固定轨道按顺序到达。**可靠，但建立连接有开销**。
        * **数据报 (开汽车)**: 每个数据包都是一辆独立的汽车，都带着完整地址，自己问路（每个路由器都独立为其选择路径）。可能失序、可能丢失。**灵活高效，但“尽最大努力交付”，不保证可靠**。**互联网（TCP/IP）采用的就是数据报服务**。
    * **拥塞控制 vs 流量控制**:
        * **流量控制 (点对点)**: 接收方感觉自己要被撑爆了，对发送方喊：“你慢点发！”。关注的是**接收方的处理能力**。
        * **拥塞控制 (全局)**: 整个路网（网络）都堵车了，路由器们向所有发送方喊：“大家都慢点发！”。关注的是**整个网络的承载能力**。

### **4.2 IPv4**

这是 **【本章的心脏，计算大题的题库】**，必须拿下。

#### **4.2.1 IPv4分组**

* **核心考点**: IPv4首部格式，特别是与**分片**相关的字段 (`标识`、`标志`、`片偏移`)。
* **形象记忆 (IP报文分片)**:
    * 一个超大的货物（IP数据报）要通过一个小尺寸的隧道（链路MTU）。必须把货物拆成几箱（分片）来运。
    * **`标识 (Identification)`**: 所有箱子都贴上**同一个运单号**，表示它们来自同一批货物。
    * **`标志 (Flags)`**:
        * `MF` (More Fragment) 位：除了**最后一个箱子** `MF=0`，其他箱子都贴上 `MF=1`，告诉接收方“后面还有”。
        * `DF` (Don't Fragment) 位：贴上 `DF=1` 表示“此货易碎，禁止拆箱”。
    * **`片偏移 (Fragment Offset)`**: 每个箱子上都标明了它装的是**原始货物**的哪一部分。**注意：单位是8字节！**

#### **4.2.2 - 4.2.3 划分子网与路由聚合 (CIDR)**

这是 **【计算大题中的王者，每年必考】**。

* **核心考点**:
    * IP地址、子网掩码、网络地址、广播地址、主机数、可用IP范围的计算。
    * 路由聚合（构造超网）。
* **【计算题模板】: 子网规划与计算**
    > **问题**: 给定IP地址 `a.b.c.d/xx`，求其网络地址、广播地址、可用主机数。

    1.  **明确分界线**: `/xx` 表示网络号（包括子网号）占 `xx` 位，主机号占 `32-xx` 位。
    2.  **计算网络地址**:
        * 将IP地址的主机号部分**全部置为0**。
        * **快捷方法**: `IP地址` 与 `子网掩码` 进行 **AND (与) 运算**。
    3.  **计算广播地址**:
        * 将IP地址的主机号部分**全部置为1**。
        * **快捷方法**: `网络地址` 的主机号部分全置为1。
    4.  **计算可用主机数**:
        * 主机号有 `n = 32 - xx` 位。
        * 总地址数 = $2^n$。
        * **可用主机数** = $2^n - 2$ (减去网络地址和广播地址)。
    5.  **计算可用IP地址范围**:
        * 最小可用IP = `网络地址 + 1`。
        * 最大可用IP = `广播地址 - 1`。

* **【计算题模板】: 路由聚合 (构造超网)**
    > **问题**: 将多个连续的子网 `N1, N2, ...` 聚合成一个超网。

    1.  **写出二进制**: 将所有子网的网络地址写成二进制形式。
    2.  **找共同前缀**: 从左到右，找到所有地址都**相同的最长前缀**。
    3.  **得出结果**:
        * 超网的网络地址 = 共同前缀 + 后面全补0。
        * 超网的掩码 = 共同前缀的位数。
        * **例如**: `192.168.0.0/24` 和 `192.168.1.0/24` 的共同前缀是23位，聚合后为 `192.168.0.0/23`。

#### **4.2.5 地址解析协议 (ARP)**

* **核心考点**: ARP的功能和工作流程。
* **形象记忆**:
    * **场景**: 你在教学楼（局域网）里，知道张三（目的IP）的名字，但不知道他在哪个教室（MAC地址）。
    * **ARP请求 (广播)**: 你在教学楼的广播里大喊：“张三！你在哪个教室？”。**广播，所有人都听得到**。
    * **ARP响应 (单播)**: 张三听到后，走到你面前（单播）悄悄告诉你：“我在201教室”。
    * **ARP缓存**: 你把“张三在201教室”记在小本本上，下次就不用再喊了。
    * **跨网络**: 如果你要找校外的人，你会去问**门卫大爷**（**默认网关**），让大爷帮你联系。你只会得到门卫大爷的MAC地址。

#### **4.2.6 动态主机配置协议 (DHCP)**

* **核心考点**: 主机如何自动获取IP地址。
* **形象记忆**:
    * **场景**: 你新搬进一栋公寓（网络），需要一个房间号（IP地址）。
    * **DHCP发现 (广播)**: 你在楼道里大喊：“管理员（DHCP服务器）在吗？给我个房间号！” (源IP `0.0.0.0`)
    * **DHCP提供 (广播)**: 管理员回复：“201房间空着，给你用吧！”
    * **DHCP请求 (广播)**: 你再次大喊：“大家听好，我就要201了！” (为了通知其他可能回复的管理员)
    * **DHCP确认 (广播)**: 管理员最终确认：“好的，201归你了，租期一天！”

#### **4.2.7 网际控制报文协议 (ICMP)**

* **核心考点**: ICMP的功能和常见报文类型。
* **形象记忆**:
    * **功能**: IP协议的“**侦察兵**”和“**信使**”，负责报告网络中的各种异常情况。
    * **常见应用**:
        * `PING`: 使用“**回送请求/应答**”报文。就像你对山谷喊一声“喂”，如果听到回声，说明路是通的。
        * `Traceroute`: 使用“**TTL超时**”报文。通过不断发送TTL=1, 2, 3...的包，看它在哪一跳“死掉”并收到“死亡通知”，从而探明路径。

### **4.3 IPv6**

* **核心考点**:
    * 为什么需要IPv6（地址耗尽）。
    * IPv6的主要特点（地址空间巨大、首部简化、即插即用）。
    * IPv6地址表示法（冒号十六进制、零压缩）。
    * 从IPv4到IPv6的过渡技术。
* **形象记忆**:
    * **IPv4地址**: 像地球上的电话号码，快用完了。
    * **IPv6地址**: 像宇宙中每一粒沙子都能分到一个编号，永远用不完。
    * **零压缩**: `2001:0DB8:0000:0000:0000:FF00:0042:8329` 可以压缩成 `2001:DB8::FF00:42:8329`。`::`只能用一次。
    * **过渡技术**:
        * **双协议栈**: 一个人同时会说中文(IPv4)和英文(IPv6)。
        * **隧道技术**: 把一封英文信(IPv6包)装进一个中文信封(IPv4包)里，通过只懂中文的邮政系统投递。

### **4.4 路由算法与路由协议**

这是 **【本章的另一座大山，概念和过程理解是重点】**。

* **核心考点**:
    * 两大路由算法：`距离-向量` 和 `链路-状态`。
    * 三大路由协议：`RIP`, `OSPF`, `BGP` 的对比。
* **形象记忆 (寻宝)**:
    * **距离-向量算法 (RIP)**:
        * **原理**: “**听邻居说**”。每个寻宝者只和相邻的人交流，告诉对方“我到各个宝藏点大概需要几步”。
        * **更新**: 定期（如30秒）交换**整个藏宝图**（路由表）。
        * **缺点**: “**好消息传得快，坏消息传得慢**”。如果一个宝藏点近了，消息很快传开；如果一个宝藏点没了，大家可能会互相欺骗很久（路由环路），收敛很慢。
    * **链路-状态算法 (OSPF)**:
        * **原理**: “**全局广播**”。每个寻宝者把自己到相邻点的距离（链路状态）广播给**所有人**。
        * **更新**: 每个人都自己拼凑出**完整的全局地图**，然后用Dijkstra算法自己算最短路径。只在路况变化时才广播。
        * **优点**: 收敛快，无环路，更可靠。
    * **三大协议对比**:
        * **RIP (内部网关)**: **距离向量**算法，用**跳数**衡量距离，基于**UDP**。适用于**小型网络**。
        * **OSPF (内部网关)**: **链路状态**算法，用**开销**（带宽等）衡量，基于**IP**。适用于**大中型网络**。
        * **BGP (外部网关)**: **路径向量**算法。AS（自治系统，如一个运营商）之间的协议。它不关心具体有多远，只关心“**要经过哪些国家（AS）**”，并遵循各种策略（如不经过某个国家）。基于**TCP**。

### **4.7 网络层设备**

* **核心考点**: 路由器的功能、组成、对广播域和冲突域的隔离。
* **形象记忆**:
    * **路由器**: 一个“**海关关口**”或“**交通枢纽**”。
        * **功能**: 连接不同的网络（国家），根据IP地址（国籍）进行**路由和转发**。
        * **组成**:
            * **控制平面 (大脑)**: 运行路由协议，生成路由表。
            * **数据平面 (四肢)**: 负责快速查找转发表并转发数据。
        * **隔离域**:
            * 路由器是**冲突域**的终结者（每个端口是一个独立的冲突域）。
            * 路由器是**广播域**的分割者（能隔离广播风暴，广播包过不了路由器）。

---

第四章的复习，要把**计算**和**原理**两手抓。**IPv4的子网划分和路由聚合**是计算的重中之重，必须做到快、准、狠。**路由协议**的对比和工作原理是理解的重点，要能用自己的话把它们之间的区别讲清楚。加油！
</div>
<div style="float: right; width: 26%; padding: 1%;">

</div>
<div style="clear: both;"></div>
