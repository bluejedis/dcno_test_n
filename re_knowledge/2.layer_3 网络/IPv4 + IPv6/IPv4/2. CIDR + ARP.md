<div style="float: left; width: 64%; padding: 1%;">

### 网络层转发分组的过程Packet forwarding process at the network layer

<ul>

#### 转发表基本信息Basic forwarding table information

<ul>

- 分组转发all基于目的主机所在网络的
  - because互联网上的**网络数**<<**主机数**
  - 极大地压缩转发表的大小
- 当分组到达路由器后，路由器根据目的IP地址的网络前缀来查找转发表，确定下一跳应当到哪个路由器
- thus，在转发表中，每条路由必须有下面两条信息：
  - （目的网络地址，下一跳地址）
- 这样，IP数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次间接交付），当到达最后一个路由器时，才试图向目的主机进行直接交付

</ul>

#### CIDR编址下的转发表查找Forwarding table lookup under CIDR addressing

<ul>

- 采用CIDR编址时，若一个分组在转发表中可以找到多个匹配的前缀，则应当使用最长前缀匹配
- 为了更快地查找转发表，可以按照前缀的长短，将前缀最长的排在第1行，按前缀长度的降序排列
- 这样，从第1行最长的开始查找，只要检索到匹配的，就不必再继续查找

</ul>

#### 特殊路由Special routes

<ul>

##### 特定主机路由Specific host routes

<ul>

> **pro：特定主机路由的应用（2009）**

- 对特定目的主机的IP地址**专门指明**一个路由，以方便网络管理员控制和测试网络
- if特定主机的IP地址是a.b.c.d，则转发表中对应项的目的网络是a.b.c.d/32
  - /32表示的子网掩码没有意义
  - but this特殊的前缀可以用在转发表中

</ul>

##### 默认路由Default route

<ul>

> **pro：默认路由的应用（2009、2014）**

- 用特殊前缀0.0.0.0/0表示默认路由
  - 全0掩码和任何目的地址进行按位与运算，结果必然为全0，即必然和前缀0.0.0.0/0相匹配
- 只要**目的网络**is**其他网络**（不在转发表中），就**一律选择默认路由**
- 默认路由通常用于 路由器 → 互联网的路由
  - 互联网包括无数的网络集合，不可能在路由表项中一一列出
  - thus只能采用默认路由的方式

</ul>

</ul>

#### 分组转发算法Packet forwarding algorithm

<ul>

- 1）从收到的IP分组的首部**提取**目的主机的IP地址D（即目的地址）
- 2）**查找**特定主机路由（目的地址为D）
  - Y
    - 按照这条路由的下一跳转发分组；  
  - N
    - 从转发表中的**下一条**（即按前缀长度的顺序）开始**检查**，执行步骤3）
- 3）将这一行的 **子网掩码 **与**目的地址D**逐位"与"（**AND**操作）
  - 若运算结果与本行的前缀匹配
    - 则查找结束
    - 按照"下一跳"指出的进行处理
    - （或者直接交付本网络上的目的主机，或通过指定接口发送到下一跳路由器）
  - 否则，若转发表还有下一行，则对下一行进行检查，重新执行步骤3）
  - 否则，执行步骤4）
    - 4）若转发表中**有一个默认路由**，则把分组传送给默认路由；否则，报告转发分组出错

</ul>

#### 转发表特点Forwarding table characteristics

<ul>

>step by step

- 转发表（或路由表）**并没有**给分组**指明**到某个网络的**完整路径**（即先经过哪个路由器，然后经过哪个路由器等）
- 转发表指出，到某个网络应当**先到**某个路由器（即**下一跳路由器** Next hop router）
  - 到达下一跳路由器后，再继续查找其转发表，知道再下一步应当到哪个路由器
- 这样一步一步地查找下去，直到最后到达目的网络

> **attention:** 
- 得到下一跳路由器的IP地址后
  - not直接将该地址填入待发送的数据报
  - but将该IP地址转 → **MAC地址**（通过ARP）
    - 将此MAC地址填入MAC帧首部
    - 然后根据这个MAC地址找到下一跳路由器
- 不同网络中传送时
  - MAC帧的源地址和目的地址要发生变化

</ul>

</ul>

### 地址解析**A**ddress **R**esolution 协议 （ARP)

<ul>

#### IP地址&硬件地址

<ul>

IP地址:  **网络层**及**网络层之上**使用的地址
- 分层式

硬件地址（MAC地址）: **数据链路层**使用的地址
- 平面式

IP地址放在IP数据报的首部，而MAC地址放在MAC帧的首部。把IP数据报封装为MAC帧后，数据链路层看不见IP数据报中的IP地址。

因为**路由器**的**隔离**，IP网络中无法通过广播MAC地址来完成跨网络的寻址，thus 在**网络层**只使用**IP地址**来完成寻址。
寻址时，每个路由器依据其路由表（依靠路由协议生成）选择到目标网络（即主机号全为0的网络地址）需要转发到的下一跳（路由器的物理端口号或下一网络地址），而IP数据报通过多次路由转发到达自标网络后，改为在自标局域网中通过数据链路层的MAC地址以广播方式寻址。这样可以提高路由选择的效率。

下列几个性质是计算机网络的精髓，有必要特别强调：

1）在**IP层抽象**的互联网上只能看到**IP数据报**。← [only**IP DG**]
2）虽然在IP数据报首部中有源IP地址，但**路由器**只根据**目的IP**地址进行转发。← [only according to **目的IP**]
3）在**局域网**的**链路层**，只能看见MAC帧。IP数据报被封装在MAC帧中。← [only **MAC帧**]
通过路由器转发时，IP数据报在**每个网络**中都被路由器**解封装**和**重新封装**，其MAC帧首部中的源地址和自的地址会不断改变。这也决定了无法使用MAC地址跨网络通信。 ← [only **IP DG** 跨网络通信]

4）尽管互连在一起的网络的硬件地址体系各不相同，但**IP层抽象**的互联网却**屏蔽**了下层这些**复杂**的**细节**。只要我们在网络层上讨论问题，就能够使用统一的、抽象的IP地址研究主机与主机或路由器之间的通信。

> **attention:**

路由器因为互连多个网络，thus 它不仅有**多个** **IP地址**，而且有多个**硬件地址**。

</ul>

#### 地址解析 Address Resolution协议

<ul>

> **pro：ARP的功能和应用（2011、2012、2021）**

无论网络层使用什么协议，在实际网络的**链路**上传送**数据帧**时，eventually必须使用MAC地址。
thus 需要一种方法来完成**IP地址**→**MAC地址**的**映射**，这就是地址解析协议（AddressResolutionProtocol，ARP）。
每台主机都设有一个**ARP高速缓存**，用来存放本局域网上各主机和路由器的IP地址到MAC地址的**映射表**，称ARP表。
使用**ARP**来**动态维护**ARP表。

> **pro：ARP请求帧的目的MAC地址（2011、2015）**

</ul>

##### ARP工作原理

<ul>

>工作在网络层

- 主机A--IP DG-->本局域网上的某台主机B时：
  - 在 **ARP高速缓存**中查看有无主机**B**的**IP地址**
    - Y：
      - 查出其对应的**硬件地址**
      - 将此硬件地址写入**MAC帧**
      - 通过局域网将该MAC帧 → 此硬件地址
    - N：
      - 使用目的MAC地址为FF-FF-FF-FF-FF-FF的帧来封装&广播ARP请求分组（广播发送）
      - 使**同**一个**局域网**里的**所有**主机都收到此ARP请求
      - 主机**B**收到该ARP请求后，向主机A发出ARP**响应**分组（单播发送）
        - 分组中包含主机B的IP地址与MAC地址的映射关系  
      - 主机A收到ARP响应分组后：
        - 将此映射写入ARP缓存
        - 按查询到的硬件地址发送MAC帧

<figure>ARP "看到了"IP地址 → work in网络层</br>
NAT路由器"看到了"端口 → work in传输层</figure>

对于某个协议工作在哪个层次，读者应该能通过协议的工作原理进行推测

> **attention:**

ARP用于解决同一局域网上的主机或路由器的IP地址和硬件地址的**映射问题**。
若目的主机和源主机 _不在_ **同一个局域网**Local area network **LAN**上，则要通过ARP找到本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络，**剩下的**工作就由**下一个网络**来做。
尽管ARP请求分组是广播发送的，但ARP响应分组是普通的单播。

</ul>

##### 使用ARP的4种典型情况

<ul>

![使用ARP的4种典型情况](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/9a0240a6e9ad5e98a9ca150689311067f19352ad0f9a539c54df2672c931882b.jpg)

</ul>

###### 1. 发送方是**主机**$\mathrm{H}_{1}$ 

<ul>

1）要把IP分组发送到**本网络**上的另一台主机（如 $\mathrm{H}_{2}$ )。
-  $\mathrm{H}_{1}$ 在网1用ARP找到目的主机 $\mathrm{H}_{2}$ 的硬件地址。

2）要把IP分组发送到**其他网络**上的一台主机（如 $\mathrm{H}_{4}.$ ）。
-  $\mathrm{H}_{1}$ 用ARP找到与网1连接的**路由器** $\bf{\mathsf{R}_{1}}$ 的硬件地址（默认网关），剩下的工作由 $\mathsf{R}_{1}$ 来完成。

>**pro: 跨局域网的帧的目的MAC地址（2015）**

**attention:**

- 开始在$\mathrm{H}_{1}$ 和$\mathrm{R}_{1}$ 之间传送时：
  - MAC帧首部中的源地址是$\mathrm{H}_{1}$ 的MAC地址
  - 目的地址是$\mathrm{L}_{1}$ 的硬件地址
  - 路由器$\mathrm{R}_{1}$收到此MAC帧后：
    - 在数据链路层，要丢弃原MAC的首部和尾部
    - 这时首部中的：
      - 源地址为$\mathrm{L}_{2}$的MAC地址
      - 目的地址为$\mathrm{L}_{3}$ 的MAC地址
- 路由器 $\mathsf{R}_{2}$ 收到此帧后：
  - 再次更换MAC帧的首部和尾部
  - 首部中的：
    - 源地址变为 L_4 的MAC地址
    - 目的地址变为$\mathrm{H}_{4}.$ 的MAC地址
- MAC帧首部的这种变化，在上面的IP层中是看不见的

</ul>

###### 2. 发送方是路由器（如 $\mathsf{R}_{1}$ )

<ul>
   
1）要把IP分组转发到与 $\mathsf{R}_{1}$ 连接的网络（**网2**）上的一台主机（如 $\mathrm{H}_{3}$
这时 $\mathsf{R}_{1}$ 在网2用ARP找到目的主机 $\mathrm{H}_{3}$ 的**硬件地址** 

2）要把IP分组转发到**网3**上的一台主机（如 $\mathrm{H}_{4}$ 
这时 $\mathsf{R}_{1}$ 在网2用ARP找到与网2连接的路由器 $\mathsf{R}_{2}$ 的硬件地址，剩下的工作由 $\bf{\mathsf{R}_{2}}$ 来完成。

从IP地址 → 硬件地址的解析是自动进行的，主机的用户并不知道这种地址解析过程。
只要主机或路由器和本网络上的另一个已知IP地址的主机或路由器进行通信，**ARP**就**自动**地将这个IP地址解析为数据链路层所需要的硬件地址。

</ul>

</ul>

</ul>

</ul>

</div>
<div style="float: right; width: 26%; padding: 1%;">

</div>
<div style="clear: both;"></div>
